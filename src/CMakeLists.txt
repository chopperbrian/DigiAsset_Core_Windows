cmake_minimum_required(VERSION 3.21)
project(digiasset_core)

#Build Version.h
configure_file(
        "${CMAKE_CURRENT_SOURCE_DIR}/Version.h.in"
        "${CMAKE_CURRENT_SOURCE_DIR}/Version.h"
)

#get list of RPC Methods
file(GLOB RPC_METHOD_SOURCES RPC/Methods/*.cpp)

# Builds RPC/MethodList.h
set(HEADER_CONTENT "///This file is automatically generated by CMakeLists.txt do not edit\n\n")
set(HEADER_CONTENT "${HEADER_CONTENT}#ifndef DIGIASSET_CORE_RPC_METHODLIST_H\n")
set(HEADER_CONTENT "${HEADER_CONTENT}#define DIGIASSET_CORE_RPC_METHODLIST_H\n\n")
set(HEADER_CONTENT "${HEADER_CONTENT}#include \"Response.h\"\n")
set(HEADER_CONTENT "${HEADER_CONTENT}#include <map>\n#include <functional>\n")
set(HEADER_CONTENT "${HEADER_CONTENT}#include \"jsoncpp/json/value.h\"\n\n")
set(HEADER_CONTENT "${HEADER_CONTENT}namespace RPC {\n")
set(HEADER_CONTENT "${HEADER_CONTENT}    namespace Methods {\n")
foreach(SOURCE_FILE ${RPC_METHOD_SOURCES})
    get_filename_component(METHOD_NAME ${SOURCE_FILE} NAME_WE)
    set(HEADER_CONTENT "${HEADER_CONTENT}        extern const Response ${METHOD_NAME}(const Json::Value& params);\n")
endforeach()
set(HEADER_CONTENT "${HEADER_CONTENT}    }\n\n")
set(HEADER_CONTENT "${HEADER_CONTENT}    extern std::map<std::string, std::function<Response(const Json::Value&)>> methods;\n\n")
set(HEADER_CONTENT "${HEADER_CONTENT}}\n\n")
set(HEADER_CONTENT "${HEADER_CONTENT}#endif  //DIGIASSET_CORE_RPC_METHODLIST_H")
file(WRITE ${CMAKE_CURRENT_SOURCE_DIR}/RPC/MethodList.h "${HEADER_CONTENT}")

# Builds RPC/MethodList.cpp
set(SOURCE_CONTENT "///This file is automatically generated by CMakeLists.txt do not edit\n\n")
set(SOURCE_CONTENT "${SOURCE_CONTENT}#include \"RPC/MethodList.h\"\n\n")
set(SOURCE_CONTENT "${SOURCE_CONTENT}namespace RPC {\n")
set(SOURCE_CONTENT "${SOURCE_CONTENT}    std::map<std::string, std::function<Response(const Json::Value&)>> methods = {\n")
foreach(SOURCE_FILE ${RPC_METHOD_SOURCES})
    get_filename_component(METHOD_NAME ${SOURCE_FILE} NAME_WE)
    set(SOURCE_CONTENT "${SOURCE_CONTENT}        {\"${METHOD_NAME}\", Methods::${METHOD_NAME}},\n")
endforeach()
set(SOURCE_CONTENT "${SOURCE_CONTENT}    };\n")
set(SOURCE_CONTENT "${SOURCE_CONTENT}}")
file(WRITE ${CMAKE_CURRENT_SOURCE_DIR}/RPC/MethodList.cpp "${SOURCE_CONTENT}")

# Build list for linker
foreach(SOURCE_FILE ${RPC_METHOD_SOURCES})
    get_filename_component(METHOD_NAME ${SOURCE_FILE} NAME_WE)
    list(APPEND RPC_METHODS_FILES ${SOURCE_FILE})
endforeach()







set(CMAKE_MODULE_PATH ${CMAKE_SOURCE_DIR}/cmake/modules)
set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} "${CMAKE_SOURCE_DIR}/cmake/")
set(CMAKE_CXX_STANDARD 11)
FIND_PACKAGE(JSONCPP REQUIRED)
FIND_PACKAGE(JSONRPCCPP REQUIRED)
find_package(CURL REQUIRED)

#add_library(ldigibyteapi STATIC IMPORTED)
add_library(lsqlite3 STATIC IMPORTED)
add_library(llibcurl STATIC IMPORTED)



set(HEADER_FILES
        static_block.hpp
        Threaded.h
        ChainAnalyzer.h
        Database.h
        DigiByteCore.h
        Blob.h
        BitIO.h
        KYC.h
        DigiAsset.h
        DigiAssetRules.h
        IPFS.h
        DigiByteTransaction.h
        Base58.h
        serialize.h
        DigiAssetTypes.h
        DigiByteDomain.h
        Config.h
        RPC/Server.h
        RPC/MethodList.h
        RPC/Response.h
        RPC/Cache.h
        DigiByteCore_Types.h
        DigiByteCore_Exception.h
        Log.h
        utils.h
        PermanentStoragePool/PermanentStoragePoolMetaProcessor.h
        PermanentStoragePool/PermanentStoragePool.h
        PermanentStoragePool/PermanentStoragePoolList.h
        PermanentStoragePool/pools/mctrivia.h
        PermanentStoragePool/pools/local.h
        AppMain.h
        CurlHandler.h
        Version.h
        OldStream.h
        UniqueTaskQueue.h
        Database_Statement.h
        Database_LockedStatement.h
        crypto/ripemd.h
        crypto/SHA256.h
        )

set(SOURCE_FILES
        Threaded.cpp
        ChainAnalyzer.cpp
        Database.cpp
        DigiByteCore.cpp
        Blob.cpp
        BitIO.cpp
        KYC.cpp
        DigiAsset.cpp
        DigiAssetRules.cpp
        IPFS.cpp
        DigiByteTransaction.cpp
        Base58.cpp
        DigiAssetTypes.cpp
        DigiByteDomain.cpp
        Config.cpp
        RPC/Server.cpp
        RPC/MethodList.cpp
        RPC/Response.cpp
        RPC/Cache.cpp
        Log.cpp
        utils.cpp
        PermanentStoragePool/PermanentStoragePoolMetaProcessor.cpp
        PermanentStoragePool/PermanentStoragePool.cpp
        PermanentStoragePool/PermanentStoragePoolList.cpp
        PermanentStoragePool/pools/mctrivia.cpp
        PermanentStoragePool/pools/local.cpp
        AppMain.cpp
        CurlHandler.cpp
        OldStream.cpp
        UniqueTaskQueue.cpp
        Database_Statement.cpp
        Database_LockedStatement.cpp
        crypto/ripemd.c
        crypto/SHA256.cpp
        )

add_executable(digiasset_core main.cpp ${SOURCE_FILES} ${HEADER_FILES} ${RPC_METHODS_FILES})

target_link_libraries(digiasset_core PRIVATE CURL::libcurl)

# Platform-specific libraries.
if(WIN32)
  find_package(SQLite3 REQUIRED)
  find_package(OpenSSL REQUIRED)
  find_package(jsoncpp REQUIRED)
  target_link_libraries(digiasset_core PRIVATE SQLite::SQLite3)
  target_link_libraries(digiasset_core PRIVATE OpenSSL::Crypto)
  target_link_libraries(digiasset_core PRIVATE jsoncpp_static)
else()
  target_link_libraries(digiasset_core PUBLIC sqlite3)
  target_link_libraries(digiasset_core PRIVATE ssl)
  target_link_libraries(digiasset_core PRIVATE crypto)
  target_link_libraries(digiasset_core PRIVATE pthread)
  target_link_libraries(digiasset_core PRIVATE /lib/x86_64-linux-gnu/libjsoncpp.so)
endif()

target_link_libraries(digiasset_core PRIVATE jsonrpccpp-common)
target_link_libraries(digiasset_core PRIVATE jsonrpccpp-client)

install(TARGETS digiasset_core DESTINATION bin)
add_library(digiasset_core_lib STATIC ${SOURCE_FILES} ${HEADER_FILES} ${RPC_METHODS_FILES})